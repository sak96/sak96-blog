<!DOCTYPE html>
<html>

<head>
  <title>My Notes: Debugging And Patching Docker</title>
  <link rel="shortcut icon" 
  href="https://sak96.github.io/theme/images/favicon.svg">
  <meta name="viewport" 
  content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8">
    <link rel="alternate" type="application/atom+xml"
    title="sak96-blog" href="https://sak96.github.io/feeds/all.atom.xml" />
  <link rel="stylesheet" href="https://sak96.github.io/theme/syntax/pygment.css">
    <style>
:root{
    --bg: #212121;
    --fg: #eeffff;
    --gray: #5c6370;
    --blue: #82aaff;
    --green: #c3e88d;
    --red: #f07178;
}
[data-theme="light"]{
    --bg: #fafafa;
    --fg: #212121;
    --gray: #90a4ae;
    --blue: #6182b8;
    --green:#91b859;
    --red: #e53935;
}
.codehilite pre{
    white-space: pre-wrap;       /* css-3 */
    white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
    white-space: -pre-wrap;      /* Opera 4-6 */
    white-space: -o-pre-wrap;    /* Opera 7 */
    word-wrap: break-word;       /* Internet Explorer 5.5+ */
}
.codehilite pre code {
  white-space: pre-wrap;
}
*{
    box-sizing: border-box;
}
body{
    background-color: var(--bg);
    color: var(--fg);
}
a{
    text-decoration: none;
    color: var(--blue);
}
h1, h2, h3, h4, h5, h6{
    color: var(--green);
}
small {
    color: var(--gray);
}
.navbar {
    border-bottom: 1px solid var(--green);
}
.navbar div {
    display: inline-block;
}
.nav-end {
    position: absolute;
    right: 0.5rem;
}
.navbar a {
    padding: 0.5rem 0;
}
.navbar a:before{
    content: "["
}
.navbar a:after{
    content: "]"
}
#navbar-toggler{
    display: none;
}
.content{
    width: 80%;
    max-width: 50rem;
    margin: auto;
}
article em,
article strong{
    color: var(--red);
}
.not-found,
.coming-soon{
    display:block;
    width: 100%;
    text-align: center;
}
.item {
    display: block;
    margin: 0.5rem 0;
    padding: 1rem;
    border-top: 1px dashed var(--red);
    color: var(--fg);
}
.item > :first-child{
    margin-top: 0;
}
.img-fluid{
    width: 100%;
}
.paginator{
    margin: 0.5rem;
    display: flex;
    justify-content: space-between;
}
.footer,
.tags {
    margin: 0.5rem;
    display: flex;
    justify-content: center;
}
.disabled {
    color: var(--gray);
}
@media only screen and (max-width: 500px){
    .navbar {
        border: none;
    }
    .nav-header {
        border-bottom: 0.025rem solid var(--green);
    }
    .navbar div {
        display: block;
        position: static;
    }
    #navbar-toggler {
        transform: rotate(90deg);
        position: absolute;
        right: 1rem;
        display: inline;
        background-color: inherit;
        border: none;
        color: inherit;
    }
    .navbar a:after,
    .navbar a:before{
        content: ""
    }
    .navbar a{
        border-bottom: 0.025rem solid var(--green);
        display: none;
    }
    .nav-header a{
        display: inline-block;
        border: none;
    }
    .navbar a.show {
        display: block;
    }
    .content {
        width: 100%;
    }
    .footer {
        display: inline-block;
    }
    .paginator span {
        display: none;
    }
}    </style>
</head>

<body>
<div class="navbar">
    <div class="nav-header"/>
        <a href="https://sak96.github.io/index.html">sak96-blog</a>
        <a id="navbar-toggler">|||</a>
    </div>
    <div class="nav-start">
        <a href="https://sak96.github.io/authors.html">Authors</a>
        <a href="https://sak96.github.io/categories.html">Categories</a>
        <a href="https://sak96.github.io/tags.html">Tags</a>
    </div>
    <div class="nav-end">
        <a href="https://sak96.github.io/feeds/all.atom.xml">Atom</a>
        <a id="theme">Theme</a>
    </div>
</div>
<script>
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(";");
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == " ") {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
    var expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + (";path=" + "https://sak96.github.io" + "/") + ";SameSite=Lax";
}
document.querySelector("#navbar-toggler").onclick = function (e) {
    document.querySelectorAll(".nav-start a,.nav-end a").forEach(
        (e) => e.classList.toggle("show")
    )
}
{
    let theme = getCookie("theme");
    if (theme !== "light"){
        document.documentElement.setAttribute('data-theme', ''); 
        setCookie("theme", "", -1); 
    }else{
        document.documentElement.setAttribute('data-theme', theme);
    }
}
document.querySelector("#theme").onclick = function (e) {
    if (document.documentElement.getAttribute('data-theme')){
        document.documentElement.setAttribute('data-theme', ''); 
        setCookie("theme", "", -1); 
    }else{
        let l = "light";
        document.documentElement.setAttribute('data-theme', l); 
        setCookie("theme", l, 365); 
    }
} </script>    <div class="content">
	<div>
		<h1>My Notes: Debugging And Patching Docker</h1>
		<h5><p>This article provide some notes for debugging and patching docker.</p></h5>
		<h5>Read time: 4 min</h5>
		<small>Written on February 29, 2020</small>
		<img class="img-fluid" src="/images/posters/working-with-container.svg">
	</div>
	<div> 
	<article>
	<p>Containerization of software and services allows easy deployment, portability and many other benefits. Docker is one of wide-spread adopted technology used for containerization. I use docker while on work. There are many guide and articles about using and debugging docker. Here is my guide for debugging and patching docker. And link to <a href="#Resources">resources</a>.</p>
<h1>Terminologies.</h1>
<ul>
<li>Docker: software used for containerization.</li>
<li>Image: snapshot of container.</li>
<li>Container: running instance of image.</li>
</ul>
<h1>Information Gathering.</h1>
<p>The first stage of any debugging session is gathering information. Skipping this steps may lead to spending hours on issue which may have been resolved in minutes.</p>
<h2>Container inspection.</h2>
<ul>
<li>Get all running container.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps
</code></pre></div>

<ul>
<li>List all containers (running, created, exited, ...).</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps -a
</code></pre></div>

<ul>
<li>Filter container list (say status=exited).</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps -a -f <span class="s2">&quot;status=exited&quot;</span>
</code></pre></div>

<ul>
<li>Get container logs.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker logs <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span>
</code></pre></div>

<ul>
<li>Get more information on the container.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker container inspect <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span>
</code></pre></div>

<h2>Images inspection.</h2>
<ul>
<li>List all docker images.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker images
</code></pre></div>

<ul>
<li>Get more information on the image.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker image inspect <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>
</code></pre></div>

<h2>Format output into JSON.</h2>
<ul>
<li>Get names of exited container.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps -a -f <span class="s2">&quot;status=exited&quot;</span> --format <span class="s2">&quot;{{json .Names}}&quot;</span>
</code></pre></div>

<h1>Live Debugging.</h1>
<p>Once information is gathered, we may need to tweak the container or live-debug. Most of these cases may require us to get a shell on the docker. The method of getting a shell may differ based on weather docker is running or docker has exited.</p>
<h2>Docker is running.</h2>
<ul>
<li>Exec into the shell (bash or sh or other shell).</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker <span class="nb">exec</span> -it <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span> /bin/sh
</code></pre></div>

<ul>
<li>Run command <code>ls ./</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker <span class="nb">exec</span> -t <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span> ls ./
</code></pre></div>

<h2>Docker has exited.</h2>
<ul>
<li>Get image, tag pair for exited container.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps -f <span class="s2">&quot;name=</span><span class="nv">$container_name</span><span class="s2">&quot;</span> --format <span class="s2">&quot;{{json .Image}}&quot;</span>
</code></pre></div>

<ul>
<li>Run image to get shell.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker run -it --entrypoint sh <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>
</code></pre></div>

<ul>
<li>Run command <code>ls ./</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker run -it --entrypoint ls <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span> ./
</code></pre></div>

<h1>Post Debugging.</h1>
<p>After figuring out the issue, You may want to patch the environment or rollback and also do some basic cleanup. Rollback would be to tag previous tag to latest. In case previous tag is not available (as it is first deployment) or the version has some specific changes which cannot be reverted and patch release may take time, then docker needs to be patched.</p>
<h2>Rollback.</h2>
<ul>
<li>Tag latest to previous version</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker tag <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_previous_tag</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:latest
</code></pre></div>

<h2>Patch.</h2>
<p>Patching depends on the method used for debugging. In case of running container you can just commit it. For exited container which was run using custom entry point, entry point is overwritten. So the patching required to revert the entry point.</p>
<h3>Docker was exec-ed.</h3>
<ul>
<li>Commit the live-debugging container.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker container commit <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>-patched
</code></pre></div>

<ul>
<li>Kill the live-debugging container</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker container <span class="nb">kill</span> <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span>
</code></pre></div>

<ul>
<li>Tag the patched version to latest.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker tag <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>-patched <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:latest
</code></pre></div>

<ul>
<li>Bring the latest service docker up.</li>
</ul>
<h3>Docker was exec-ed (entry point has changed).</h3>
<ul>
<li>Find the old entry point</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker image inspect <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span> --format <span class="s2">&quot;Entrypoint {{json .Config.Entrypoint}}&quot;</span>
</code></pre></div>

<ul>
<li>Find the old cmd</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker image inspect <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span> --format <span class="s2">&quot;CMD {{json .Config.Cmd}}&quot;</span>
</code></pre></div>

<ul>
<li>Commit the docker with the old entry point and cmd</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker container commit -change<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$old_entrypoint</span><span class="s2">&quot;</span> --change<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$old_cmd</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>-patched
</code></pre></div>

<ul>
<li>Kill the live-debugging container</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker container <span class="nb">kill</span> <span class="s2">&quot;</span><span class="nv">$container_name</span><span class="s2">&quot;</span>
</code></pre></div>

<ul>
<li>Tag the patched version to latest.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker tag <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="nv">$image_tag</span><span class="s2">&quot;</span>-patched <span class="s2">&quot;</span><span class="nv">$image_name</span><span class="s2">&quot;</span>:latest
</code></pre></div>

<ul>
<li>Bring the latest service docker up.</li>
</ul>
<h1>Cleaning up.</h1>
<ul>
<li>Delete exited container. You can use -q instead of --format flag part for getting only ids.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker ps -a -f <span class="s2">&quot;status=exited&quot;</span> --format <span class="s2">&quot;{{json .Names}}&quot;</span> <span class="p">|</span> xargs -r docker rm
</code></pre></div>

<ul>
<li>Delete untagged images.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gp">user@host$</span> docker images prune
</code></pre></div>

<h1>Tips.</h1>
<ul>
<li>Using <code>-q</code> for quiet mode on command provides only image ids or container ids. </li>
<li>Using <code>docker cp</code> can help in file transfer to and from container.<ul>
<li><code>docker cp  "$container_name":"$container_file_path" "local_file_path"</code> -&gt; from
    container.</li>
<li><code>docker cp  "local_file_path" "$container_name":"$container_file_path"</code> -&gt; to 
    container.</li>
</ul>
</li>
</ul>
<h1>Resources.</h1>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/ps/"><code>docker ps</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/images/"><code>docker images</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/image_inspect/"><code>docker image inspect</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/container_inspect/"><code>docker container inspect</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/logs/"><code>docker logs</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/container_exec/"><code>docker container exec</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/run/"><code>docker run</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/container_commit/"><code>docker container commit</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/image_prune/"><code>docker image prune</code></a></li>
<li><a href="https://docs.docker.com/config/formatting/"><code>--format</code></a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/cp/"><code>docker cp</code></a></li>
</ul>
	</article>
	</div>
<div class="tags">
    <span>Post Tags:</span>
    <a href="tag/patching.html">&nbsp;#patching,</a>
    <a href="tag/debugging.html">&nbsp;#debugging,</a>
    <a href="tag/docker.html">&nbsp;#docker</a>
</div><hr class="my-3">
<div id="comments"></div>
<script>
  let commentUrl = "https://api.github.com/repos/sak96/sak96.github.io/issues/3/comments"
  let issueUrl = "https://github.com/sak96/sak96.github.io/issues/3"
  function PopulateComment(comments) {
    commentsBlock = document.getElementById("comments");

    // comments heading
    let heading = document.createElement("div")
    heading.innerText = "Comments"
    commentsBlock.append(heading)

    // comments placeholder
    let commentsDiv = document.createElement("div")
    commentsBlock.append(commentsDiv)

    comments.forEach(comment => {
      // username 
      let username = document.createElement("span")
      username.innerText = comment.user.login

      // posting time
      updateTime = document.createElement("small")
      updateTime.innerText = "(" + comment.updated_at + ")"

      // comment body
      commentBody = document.createElement("div")
      commentBody.innerText = comment.body

      //line break
      lineBreak = document.createElement("br")

      // create comment box
      commentBox = document.createElement("a")
      commentBox.classList.add("item")
      commentBox.append(username)
      commentBox.append(updateTime)
      commentBox.append(lineBreak)
      commentBox.append(commentBody)
      commentBox.href = comment.html_url

      commentsDiv.append(commentBox)
    });

    // add comment
    let addComment = document.createElement("a")
    addComment.classList.add("item")
    addComment.href = issueUrl
    addComment.innerText = "Have some comments? Add comment ..."
    commentsDiv.append(addComment)

  }
  var xhr = new XMLHttpRequest();
  xhr.open('GET', commentUrl, true);
  xhr.responseType = 'json';
  xhr.onload = function () {
    var status = xhr.status;
    if (status === 200) {
      console.log(PopulateComment(xhr.response));
    } else {
      console.log(xhr.response);
    }
  };
  xhr.send();
</script>
<hr>
<div class="footer">
    <span>Powered by:</span>
    <a href="http://getpelican.com/">Pelican,</a>
    <a href="https://github.com/pygments/pygments">Pygments,</a>
    <a href="https://github.com/rakr/vim-one">Vim-One</a>
</div>  </div>
</body>
</html>